# Apache VirtualHost configuration for Vedic Astrology Calculator
# Production-ready with SSL, security headers, and performance optimizations

<IfModule mod_ssl.c>
    <VirtualHost *:443>
        ServerName vedic-astrology.local  # Change to your domain
        ServerAlias www.vedic-astrology.local
        
        DocumentRoot /var/www/html
        
        # SSL Configuration
        SSLEngine on
        SSLCertificateFile /etc/apache2/ssl/cert.pem
        SSLCertificateKeyFile /etc/apache2/ssl/key.pem
        SSLCertificateChainFile /etc/apache2/ssl/chain.pem
        
        # Modern SSL configuration
        SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
        SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
        SSLHonorCipherOrder off
        SSLSessionTickets off
        
        # HSTS Header
        Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
        
        # Security Headers
        Header always set X-Frame-Options "SAMEORIGIN"
        Header always set X-XSS-Protection "1; mode=block"
        Header always set X-Content-Type-Options "nosniff"
        Header always set Referrer-Policy "no-referrer-when-downgrade"
        Header always set Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'"
        
        # Hide server signature
        ServerTokens Prod
        Header unset Server
        
        # Enable compression
        <IfModule mod_deflate.c>
            SetOutputFilter DEFLATE
            SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
            SetEnvIfNoCase Request_URI \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
            SetEnvIfNoCase Request_URI \.pdf$ no-gzip dont-vary
            BrowserMatch ^Mozilla/4 gzip-only-text/html
            BrowserMatch ^Mozilla/4\.0[678] no-gzip
            BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
        </IfModule>
        
        # Static files with caching
        <Directory "/app/static">
            Options -Indexes
            AllowOverride None
            Require all granted
            
            <IfModule mod_expires.c>
                ExpiresActive On
                ExpiresDefault "access plus 1 year"
                ExpiresByType text/css "access plus 1 year"
                ExpiresByType application/javascript "access plus 1 year"
                ExpiresByType image/* "access plus 1 year"
            </IfModule>
        </Directory>
        
        # Proxy to FastAPI backend
        <IfModule mod_proxy.c>
            ProxyPreserveHost On
            ProxyRequests Off
            
            # API endpoints
            ProxyPass /chart http://127.0.0.1:5000/chart retry=3 timeout=30
            ProxyPassReverse /chart http://127.0.0.1:5000/chart
            
            ProxyPass /docs http://127.0.0.1:5000/docs retry=3 timeout=30
            ProxyPassReverse /docs http://127.0.0.1:5000/docs
            
            ProxyPass /openapi.json http://127.0.0.1:5000/openapi.json retry=3 timeout=30
            ProxyPassReverse /openapi.json http://127.0.0.1:5000/openapi.json
            
            # Admin panel with IP restriction
            <Location "/admin">
                ProxyPass http://127.0.0.1:5000/admin retry=3 timeout=30
                ProxyPassReverse http://127.0.0.1:5000/admin
                
                # Restrict access to admin
                <RequireAll>
                    Require ip 127.0.0.1
                    Require ip 192.168.1.0/24
                    # Add your IP ranges here
                </RequireAll>
            </Location>
            
            # Root and catch-all
            ProxyPass / http://127.0.0.1:5000/ retry=3 timeout=30
            ProxyPassReverse / http://127.0.0.1:5000/
            
            # Set proxy headers
            ProxyPassReverse / http://127.0.0.1:5000/
            ProxyPassReverse / https://vedic-astrology.local/
        </IfModule>
        
        # Rate limiting (requires mod_evasive)
        <IfModule mod_evasive24.c>
            DOSHashTableSize    2048
            DOSPageCount        10
            DOSPageInterval     1
            DOSSiteCount        50
            DOSSiteInterval     1
            DOSBlockingPeriod   600
        </IfModule>
        
        # Logging
        ErrorLog ${APACHE_LOG_DIR}/vedic-astrology-error.log
        CustomLog ${APACHE_LOG_DIR}/vedic-astrology-access.log combined
        
        # Security: Deny access to sensitive files
        <FilesMatch "\.(py|pyc|conf|ini|log)$">
            Require all denied
        </FilesMatch>
        
        # Deny access to hidden files
        <DirectoryMatch "^\.|\/\.">
            Require all denied
        </DirectoryMatch>
    </VirtualHost>
</IfModule>

# HTTP redirect to HTTPS
<VirtualHost *:80>
    ServerName vedic-astrology.local
    ServerAlias www.vedic-astrology.local
    
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>