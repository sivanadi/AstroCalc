<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel - Vedic Astrology Calculator</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .login-form { 
            max-width: 450px; 
            margin: 50px auto; 
            padding: 30px; 
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        input, button { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            box-sizing: border-box; 
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        input:focus { 
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        button { 
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; 
            border: none; 
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .error { color: red; }
        .success { color: green; }
        .admin-panel { 
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .section { 
            margin: 25px 0; 
            padding: 25px; 
            background: #f8f9fa;
            border: 1px solid #e9ecef; 
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        /* Enhanced Form Layouts */
        .form-group {
            margin-bottom: 20px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .form-row input {
            margin: 0;
        }
        .limits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .limits-grid input {
            margin: 0;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            display: block;
            font-size: 14px;
        }
        
        /* Clean Item Cards */
        .item-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .item-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }
        .item-title {
            font-weight: 600;
            color: #343a40;
            font-size: 16px;
            margin: 0;
        }
        .item-subtitle {
            color: #6c757d;
            font-size: 14px;
            margin: 4px 0;
        }
        .item-meta {
            color: #868e96;
            font-size: 12px;
            display: flex;
            gap: 15px;
            margin: 8px 0;
        }
        .item-actions {
            margin-top: 12px;
            text-align: right;
        }
        .btn-danger {
            background: #dc3545;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            margin: 0;
        }
        .btn-danger:hover {
            background: #c82333;
            transform: none;
            box-shadow: none;
        }
        
        /* Section Headers */
        .section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }
        
        /* Lists Container */
        .items-container {
            margin-top: 25px;
        }
        .items-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .login-form, .admin-panel { 
                margin: 20px auto;
                padding: 20px;
            }
            .section {
                padding: 15px;
                margin: 15px 0;
            }
            input, button {
                padding: 15px;
                font-size: 16px;
            }
            .limits-grid {
                grid-template-columns: 1fr;
            }
            .form-row {
                flex-direction: column;
                gap: 5px;
            }
            .item-meta {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .login-form { 
                max-width: 95%;
                margin: 10px auto;
            }
        }
    </style>
</head>
<body>
    <div class="login-form" id="loginForm">
        <h2>Admin Login</h2>
        <form onsubmit="adminLogin(event)">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
        <div id="loginMessage"></div>
    </div>
    
    <div class="admin-panel" id="adminPanel">
        <h1>Admin Panel</h1>
        
        <div class="section">
            <h3>üîë API Keys Management</h3>
            
            <!-- Information Notice -->
            <div style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <h4 style="margin: 0 0 10px 0; color: #1565c0;">‚ÑπÔ∏è Important: API Key Security</h4>
                <ul style="margin: 5px 0; padding-left: 20px; color: #1565c0; font-size: 14px; line-height: 1.6;">
                    <li><strong>API keys are shown only once</strong> when created. Copy and save them securely!</li>
                    <li><strong>Lost your API key?</strong> Use the "View Hash" button to see the key's identifier, or create a new key.</li>
                    <li><strong>Testing keys:</strong> Use the diagnostic test below with the exact API key value (not the hash).</li>
                    <li><strong>Security:</strong> Only the cryptographic hash is stored in our database, never the original key.</li>
                </ul>
            </div>
            
            <form onsubmit="createApiKey(event)">
                <div class="form-group">
                    <label class="form-label">API Key Name</label>
                    <input type="text" id="keyName" placeholder="Enter a descriptive name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <input type="text" id="keyDesc" placeholder="Brief description of usage">
                </div>
                <div class="form-group">
                    <label class="form-label">Rate Limits</label>
                    <div class="limits-grid">
                        <input type="number" id="keyPerMinute" placeholder="Per minute" min="1" value="60">
                        <input type="number" id="keyPerDay" placeholder="Per day" min="1" value="1000">
                        <input type="number" id="keyPerMonth" placeholder="Per month" min="1" value="30000">
                    </div>
                </div>
                <button type="submit">Create API Key</button>
            </form>
            <div id="apiKeysList" class="items-container"></div>
        </div>
        
        <div class="section">
            <h3>üåê Authorized Domains</h3>
            <form onsubmit="addDomain(event)">
                <div class="form-group">
                    <label class="form-label">Domain Name</label>
                    <input type="text" id="domainName" placeholder="e.g., example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Rate Limits</label>
                    <div class="limits-grid">
                        <input type="number" id="domainPerMinute" placeholder="Per minute" min="1" value="10">
                        <input type="number" id="domainPerDay" placeholder="Per day" min="1" value="100">
                        <input type="number" id="domainPerMonth" placeholder="Per month" min="1" value="3000">
                    </div>
                </div>
                <button type="submit">Add Domain</button>
            </form>
            <div id="domainsList" class="items-container"></div>
        </div>
        
        <div class="section">
            <h3>üìä Analytics Dashboard</h3>
            <p>View comprehensive API usage analytics, KPI metrics, and performance monitoring.</p>
            <a href="/static/analytics.html" style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0px)'">
                üìä Open Analytics Dashboard
            </a>
        </div>
        
        <div class="section">
            <h3>üîß Diagnosis & Debugging</h3>
            <p>Diagnostic tools for troubleshooting API access issues and debugging authentication problems.</p>
            
            <!-- Current Status Display -->
            <div style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <h4 style="margin: 0 0 10px 0; color: #0c5460;">üö¶ Current Status</h4>
                <div id="diagnosticStatus">
                    <p>Loading diagnostic status...</p>
                </div>
            </div>
            
            <!-- API Key Enforcement Toggle -->
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è API Key Enforcement Control</h4>
                <p style="color: #856404; font-size: 14px; margin: 0 0 15px 0;">
                    <strong>Warning:</strong> Disabling API key enforcement removes all authentication. Use only for debugging.
                </p>
                
                <form onsubmit="toggleEnforcement(event)">
                    <div style="display: flex; gap: 15px; align-items: center; margin: 10px 0;">
                        <label style="font-weight: 600;">
                            <input type="radio" name="enforcement" value="enable" checked> Enable Enforcement
                        </label>
                        <label style="font-weight: 600;">
                            <input type="radio" name="enforcement" value="disable"> Disable Enforcement
                        </label>
                    </div>
                    
                    <div id="bypassSettings" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <div class="form-group">
                            <label class="form-label">Duration (minutes) *</label>
                            <input type="number" id="bypassDuration" min="1" max="1440" value="30" required>
                            <small style="color: #6c757d;">Auto-expire after specified time (max 24 hours)</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Allowed IPs (optional)</label>
                            <input type="text" id="allowedIPs" placeholder="192.168.1.1, 10.0.0.0/8" style="margin: 0;">
                            <small style="color: #6c757d;">Comma-separated IPs/CIDR ranges. Leave empty to use your current IP.</small>
                        </div>
                    </div>
                    
                    <button type="submit">Apply Changes</button>
                </form>
                <div id="toggleMessage" style="margin-top: 10px;"></div>
            </div>
            
            <!-- Diagnostic Tests -->
            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <h4 style="margin: 0 0 10px 0; color: #155724;">üîç Diagnostic Tests</h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 15px 0;">
                    
                    <!-- API Key Test -->
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px;">
                        <h5 style="margin: 0 0 10px 0;">Test API Key</h5>
                        <form onsubmit="runTest(event, 'api_key')">
                            <input type="text" id="testApiKey" placeholder="Enter API key to test" required style="margin-bottom: 10px;">
                            <button type="submit" style="font-size: 14px; padding: 8px 16px;">Test API Key</button>
                        </form>
                    </div>
                    
                    <!-- Bypass Test -->
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px;">
                        <h5 style="margin: 0 0 10px 0;">Test Bypass Settings</h5>
                        <form onsubmit="runTest(event, 'bypass')">
                            <button type="submit" style="font-size: 14px; padding: 8px 16px;">Test Bypass Conditions</button>
                        </form>
                    </div>
                </div>
                
                <div id="testResults" style="margin-top: 15px;"></div>
            </div>
            
            <!-- Diagnostic Logs -->
            <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <h4 style="margin: 0 0 10px 0; color: #495057;">üìã Diagnostic Logs</h4>
                
                <div style="display: flex; gap: 10px; margin: 10px 0; align-items: center; flex-wrap: wrap;">
                    <select id="logOutcomeFilter" style="padding: 5px; border: 1px solid #ced4da; border-radius: 4px;">
                        <option value="">All Outcomes</option>
                        <option value="allowed">Allowed</option>
                        <option value="denied">Denied</option>
                        <option value="bypass_active">Bypass Active</option>
                        <option value="enforcement_disabled">Enforcement Disabled</option>
                    </select>
                    <input type="text" id="logIpFilter" placeholder="Filter by IP" style="padding: 5px; border: 1px solid #ced4da; border-radius: 4px; margin: 0; width: 150px;">
                    <button onclick="loadDiagnosticLogs()" style="padding: 5px 15px; font-size: 14px;">Refresh Logs</button>
                </div>
                
                <div id="diagnosticLogs" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; background: white; border-radius: 5px;">
                    <p style="text-align: center; padding: 20px; color: #6c757d;">Click "Refresh Logs" to load diagnostic data</p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>üîê Change Password</h3>
            <form onsubmit="changePassword(event)">
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password" required>
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" id="newPassword" placeholder="Min 8 chars, 1 digit, 1 uppercase" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
                </div>
                <button type="submit">Change Password</button>
            </form>
            <div id="passwordChangeMessage"></div>
        </div>
        
        <button onclick="logout()">Logout</button>
    </div>
    
    <script>
        let sessionToken = localStorage.getItem('adminToken');
        
        if (sessionToken) {
            showAdminPanel();
        }
        
        async function adminLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    sessionToken = data.token;
                    localStorage.setItem('adminToken', sessionToken);
                    showAdminPanel();
                } else {
                    const loginMessage = document.getElementById('loginMessage');
                    loginMessage.innerHTML = '';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.textContent = data.detail;
                    loginMessage.appendChild(errorDiv);
                }
            } catch (error) {
                console.error('Login error:', error);
                const loginMessage = document.getElementById('loginMessage');
                loginMessage.innerHTML = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'Login failed';
                loginMessage.appendChild(errorDiv);
            }
        }
        
        function showAdminPanel() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadApiKeys();
            loadDomains();
            loadDiagnosticStatus();
        }
        
        async function loadApiKeys() {
            try {
                const response = await fetch('/admin/api-keys', {
                    headers: { 'Authorization': 'Bearer ' + sessionToken }
                });
                const data = await response.json();
                
                const apiKeysList = document.getElementById('apiKeysList');
                apiKeysList.innerHTML = '';
                
                if (Object.keys(data.api_keys).length > 0) {
                    const title = document.createElement('div');
                    title.className = 'items-title';
                    title.textContent = 'Active API Keys';
                    apiKeysList.appendChild(title);
                    
                    for (let key in data.api_keys) {
                        const keyInfo = data.api_keys[key];
                        const keyCard = document.createElement('div');
                        keyCard.className = 'item-card';
                        
                        const header = document.createElement('div');
                        header.className = 'item-header';
                        
                        const title = document.createElement('h4');
                        title.className = 'item-title';
                        title.textContent = keyInfo.name;
                        header.appendChild(title);
                        
                        const subtitle = document.createElement('div');
                        subtitle.className = 'item-subtitle';
                        subtitle.textContent = `Key: ${key}`;
                        
                        const meta = document.createElement('div');
                        meta.className = 'item-meta';
                        meta.innerHTML = `
                            <span>${keyInfo.per_minute_limit}/min</span>
                            <span>${keyInfo.per_day_limit}/day</span>
                            <span>${keyInfo.per_month_limit}/month</span>
                        `;
                        
                        if (keyInfo.description) {
                            const desc = document.createElement('div');
                            desc.className = 'item-subtitle';
                            desc.style.fontStyle = 'italic';
                            desc.textContent = keyInfo.description;
                            keyCard.appendChild(header);
                            keyCard.appendChild(subtitle);
                            keyCard.appendChild(desc);
                            keyCard.appendChild(meta);
                        } else {
                            keyCard.appendChild(header);
                            keyCard.appendChild(subtitle);
                            keyCard.appendChild(meta);
                        }
                        
                        const actions = document.createElement('div');
                        actions.className = 'item-actions';
                        
                        const viewHashBtn = document.createElement('button');
                        viewHashBtn.textContent = 'View Hash';
                        viewHashBtn.style.cssText = 'background: #17a2b8; color: white; padding: 6px 12px; font-size: 12px; border-radius: 4px; margin: 0 5px 0 0; border: none; cursor: pointer;';
                        viewHashBtn.onclick = () => showKeyHash(key, keyInfo.name);
                        actions.appendChild(viewHashBtn);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.className = 'btn-danger';
                        deleteBtn.onclick = () => deleteApiKey(key);
                        actions.appendChild(deleteBtn);
                        keyCard.appendChild(actions);
                        
                        apiKeysList.appendChild(keyCard);
                    }
                } else {
                    const emptyState = document.createElement('div');
                    emptyState.style.textAlign = 'center';
                    emptyState.style.color = '#6c757d';
                    emptyState.style.padding = '40px 20px';
                    emptyState.innerHTML = '<p>No API keys created yet.<br>Create your first API key using the form above.</p>';
                    apiKeysList.appendChild(emptyState);
                }
            } catch (error) {
                console.error('Failed to load API keys');
            }
        }
        
        async function loadDomains() {
            try {
                const response = await fetch('/admin/domains', {
                    headers: { 'Authorization': 'Bearer ' + sessionToken }
                });
                const data = await response.json();
                
                const domainsList = document.getElementById('domainsList');
                domainsList.innerHTML = '';
                
                if (data.domains.length > 0) {
                    const title = document.createElement('div');
                    title.className = 'items-title';
                    title.textContent = 'Authorized Domains';
                    domainsList.appendChild(title);
                    
                    data.domains.forEach(domainObj => {
                        const domainCard = document.createElement('div');
                        domainCard.className = 'item-card';
                        
                        const header = document.createElement('div');
                        header.className = 'item-header';
                        
                        const title = document.createElement('h4');
                        title.className = 'item-title';
                        title.textContent = domainObj.domain;
                        header.appendChild(title);
                        
                        const meta = document.createElement('div');
                        meta.className = 'item-meta';
                        meta.innerHTML = `
                            <span>${domainObj.per_minute_limit}/min</span>
                            <span>${domainObj.per_day_limit}/day</span>
                            <span>${domainObj.per_month_limit}/month</span>
                        `;
                        
                        const actions = document.createElement('div');
                        actions.className = 'item-actions';
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.className = 'btn-danger';
                        deleteBtn.onclick = () => deleteDomain(domainObj.domain);
                        actions.appendChild(deleteBtn);
                        
                        domainCard.appendChild(header);
                        domainCard.appendChild(meta);
                        domainCard.appendChild(actions);
                        
                        domainsList.appendChild(domainCard);
                    });
                } else {
                    const emptyState = document.createElement('div');
                    emptyState.style.textAlign = 'center';
                    emptyState.style.color = '#6c757d';
                    emptyState.style.padding = '40px 20px';
                    emptyState.innerHTML = '<p>No domains authorized yet.<br>Add your first domain using the form above.</p>';
                    domainsList.appendChild(emptyState);
                }
            } catch (error) {
                console.error('Failed to load domains');
            }
        }
        
        async function createApiKey(event) {
            event.preventDefault();
            const name = document.getElementById('keyName').value;
            const description = document.getElementById('keyDesc').value;
            const per_minute_limit = parseInt(document.getElementById('keyPerMinute').value) || 60;
            const per_day_limit = parseInt(document.getElementById('keyPerDay').value) || 1000;
            const per_month_limit = parseInt(document.getElementById('keyPerMonth').value) || 30000;
            
            try {
                const response = await fetch('/admin/api-keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: JSON.stringify({ 
                        name, 
                        description, 
                        per_minute_limit,
                        per_day_limit,
                        per_month_limit
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('API Key Creation Response:', data); // Debug log
                    
                    // Check if API key exists in response
                    if (!data.api_key) {
                        console.error('No API key in response:', data);
                        alert('Error: API key not returned from server');
                        return;
                    }
                    
                    // Display the newly created API key prominently - ADD TO PARENT SECTION NOT THE LIST
                    const apiKeysSection = document.querySelector('.section:has(#apiKeysList)') || document.getElementById('apiKeysList').closest('.section');
                    
                    // Clear any existing new key alerts first
                    const existingAlerts = document.querySelectorAll('[data-new-key-alert]');
                    existingAlerts.forEach(alert => alert.remove());
                    
                    const newKeyAlert = document.createElement('div');
                    newKeyAlert.setAttribute('data-new-key-alert', 'true');
                    newKeyAlert.style.cssText = 'background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 20px 0; border-left: 4px solid #28a745; position: relative; z-index: 100;';
                    
                    const alertTitle = document.createElement('h4');
                    alertTitle.style.cssText = 'margin: 0 0 15px 0; color: #155724;';
                    alertTitle.innerHTML = 'üéâ New API Key Created Successfully!';
                    
                    const alertText = document.createElement('p');
                    alertText.style.cssText = 'margin: 10px 0; color: #155724; font-weight: 600;';
                    alertText.textContent = 'IMPORTANT: Copy this API key now. You won\'t be able to see it again!';
                    
                    const keyContainer = document.createElement('div');
                    keyContainer.style.cssText = 'background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin: 10px 0; font-family: monospace; word-break: break-all; position: relative;';
                    
                    const keyLabel = document.createElement('div');
                    keyLabel.style.cssText = 'font-size: 14px; color: #6c757d; margin-bottom: 5px; font-family: sans-serif;';
                    keyLabel.textContent = 'Your API Key:';
                    
                    const keyValue = document.createElement('div');
                    keyValue.style.cssText = 'font-size: 16px; color: #212529; font-weight: 600; user-select: all; cursor: pointer;';
                    keyValue.textContent = data.api_key;
                    keyValue.onclick = function() {
                        navigator.clipboard.writeText(data.api_key).then(() => {
                            const originalText = keyValue.textContent;
                            keyValue.textContent = '‚úì Copied to clipboard!';
                            keyValue.style.color = '#28a745';
                            setTimeout(() => {
                                keyValue.textContent = originalText;
                                keyValue.style.color = '#212529';
                            }, 2000);
                        });
                    };
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'Copy to Clipboard';
                    copyBtn.style.cssText = 'background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer; font-size: 14px;';
                    copyBtn.onclick = function() {
                        navigator.clipboard.writeText(data.api_key).then(() => {
                            copyBtn.textContent = '‚úì Copied!';
                            copyBtn.style.background = '#20c997';
                            setTimeout(() => {
                                copyBtn.textContent = 'Copy to Clipboard';
                                copyBtn.style.background = '#28a745';
                            }, 2000);
                        });
                    };
                    
                    const dismissBtn = document.createElement('button');
                    dismissBtn.textContent = '√ó Dismiss';
                    dismissBtn.style.cssText = 'background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 10px 0 0 10px; cursor: pointer; font-size: 14px;';
                    dismissBtn.onclick = function() {
                        newKeyAlert.remove();
                    };
                    
                    keyContainer.appendChild(keyLabel);
                    keyContainer.appendChild(keyValue);
                    
                    newKeyAlert.appendChild(alertTitle);
                    newKeyAlert.appendChild(alertText);
                    newKeyAlert.appendChild(keyContainer);
                    newKeyAlert.appendChild(copyBtn);
                    newKeyAlert.appendChild(dismissBtn);
                    
                    // Clear the form first
                    document.getElementById('keyName').value = '';
                    document.getElementById('keyDesc').value = '';
                    document.getElementById('keyPerMinute').value = '60';
                    document.getElementById('keyPerDay').value = '1000';
                    document.getElementById('keyPerMonth').value = '30000';
                    
                    // Insert the popup into the section (BEFORE loadApiKeys clears the list)
                    const apiKeysList = document.getElementById('apiKeysList');
                    apiKeysSection.insertBefore(newKeyAlert, apiKeysList);
                    
                    // Reload the keys list AFTER popup is safely placed
                    await loadApiKeys();
                    
                    // Scroll to the new key alert and ensure it's visible
                    setTimeout(() => {
                        newKeyAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        console.log('Popup should be visible now!'); // Debug log
                    }, 100);
                } else {
                    // Handle non-200 responses
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('API Key creation failed:', response.status, errorData);
                    alert(`Failed to create API key: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Failed to create API key:', error);
                alert(`Error creating API key: ${error.message}`);
            }
        }
        
        async function addDomain(event) {
            event.preventDefault();
            const domain = document.getElementById('domainName').value;
            const per_minute_limit = parseInt(document.getElementById('domainPerMinute').value) || 10;
            const per_day_limit = parseInt(document.getElementById('domainPerDay').value) || 100;
            const per_month_limit = parseInt(document.getElementById('domainPerMonth').value) || 3000;
            
            try {
                const response = await fetch('/admin/domains', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: JSON.stringify({ 
                        domain,
                        per_minute_limit,
                        per_day_limit,
                        per_month_limit
                    })
                });
                
                if (response.ok) {
                    document.getElementById('domainName').value = '';
                    document.getElementById('domainPerMinute').value = '10';
                    document.getElementById('domainPerDay').value = '100';
                    document.getElementById('domainPerMonth').value = '3000';
                    loadDomains();
                }
            } catch (error) {
                console.error('Failed to add domain');
            }
        }
        
        async function deleteApiKey(key) {
            if (confirm('Delete this API key?')) {
                try {
                    await fetch('/admin/api-keys/' + key, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + sessionToken }
                    });
                    loadApiKeys();
                } catch (error) {
                    console.error('Failed to delete API key');
                }
            }
        }
        
        async function deleteDomain(domain) {
            if (confirm('Remove this domain?')) {
                try {
                    await fetch('/admin/domains/' + domain, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + sessionToken }
                    });
                    loadDomains();
                } catch (error) {
                    console.error('Failed to delete domain');
                }
            }
        }
        
        async function changePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                document.getElementById('passwordChangeMessage').innerHTML = '<div class="error">New passwords do not match</div>';
                return;
            }
            
            try {
                const response = await fetch('/admin/password-change', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: JSON.stringify({ 
                        current_password: currentPassword, 
                        new_password: newPassword 
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('passwordChangeMessage').innerHTML = '<div class="success">' + data.message + '</div>';
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    document.getElementById('passwordChangeMessage').innerHTML = '<div class="error">' + data.detail + '</div>';
                }
            } catch (error) {
                document.getElementById('passwordChangeMessage').innerHTML = '<div class="error">Failed to change password</div>';
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }
        
        // Diagnosis Functions
        async function loadDiagnosticStatus() {
            try {
                const response = await fetch('/admin/diagnostics/status', {
                    headers: { 'Authorization': 'Bearer ' + sessionToken }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('adminToken');
                    location.reload();
                    return;
                }
                const data = await response.json();
                
                const statusDiv = document.getElementById('diagnosticStatus');
                statusDiv.textContent = ''; // Clear existing content
                
                const enforcementStatus = data.api_key_enforcement_enabled ? 'ENABLED' : 'DISABLED';
                const enforcementColor = data.api_key_enforcement_enabled ? '#28a745' : '#dc3545';
                
                // Create safe DOM structure to prevent XSS
                const gridContainer = document.createElement('div');
                gridContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;';
                
                // Enforcement status card
                const enforcementCard = document.createElement('div');
                enforcementCard.style.cssText = `background: white; padding: 10px; border-radius: 5px; border-left: 3px solid ${enforcementColor};`;
                
                const enforcementLabel = document.createElement('strong');
                enforcementLabel.textContent = 'API Key Enforcement:';
                const enforcementBreak = document.createElement('br');
                const enforcementValue = document.createElement('span');
                enforcementValue.style.cssText = `color: ${enforcementColor}; font-weight: 600;`;
                enforcementValue.textContent = enforcementStatus;
                
                enforcementCard.appendChild(enforcementLabel);
                enforcementCard.appendChild(enforcementBreak);
                enforcementCard.appendChild(enforcementValue);
                gridContainer.appendChild(enforcementCard);
                
                // Environment card
                const envCard = document.createElement('div');
                envCard.style.cssText = 'background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #17a2b8;';
                
                const envLabel = document.createElement('strong');
                envLabel.textContent = 'Environment:';
                const envBreak = document.createElement('br');
                const envValue = document.createElement('span');
                envValue.style.cssText = 'color: #17a2b8; font-weight: 600;';
                envValue.textContent = data.environment.toUpperCase(); // Safe: textContent prevents XSS
                
                envCard.appendChild(envLabel);
                envCard.appendChild(envBreak);
                envCard.appendChild(envValue);
                gridContainer.appendChild(envCard);
                
                // Bypass card (if active)
                if (data.bypass_enabled) {
                    const expiresAt = new Date(data.bypass_expires_at);
                    const now = new Date();
                    const timeLeft = Math.max(0, Math.floor((expiresAt - now) / 60000));
                    
                    const bypassCard = document.createElement('div');
                    bypassCard.style.cssText = 'background: white; padding: 10px; border-radius: 5px; border-left: 3px solid #ffc107;';
                    
                    const bypassLabel = document.createElement('strong');
                    bypassLabel.textContent = 'Bypass Active:';
                    const bypassBreak = document.createElement('br');
                    const bypassValue = document.createElement('span');
                    bypassValue.style.cssText = 'color: #856404; font-weight: 600;';
                    bypassValue.textContent = `${timeLeft} min left`;
                    
                    bypassCard.appendChild(bypassLabel);
                    bypassCard.appendChild(bypassBreak);
                    bypassCard.appendChild(bypassValue);
                    gridContainer.appendChild(bypassCard);
                }
                
                statusDiv.appendChild(gridContainer);
                
                // Update radio buttons
                const enableRadio = document.querySelector('input[name="enforcement"][value="enable"]');
                const disableRadio = document.querySelector('input[name="enforcement"][value="disable"]');
                
                if (data.api_key_enforcement_enabled) {
                    enableRadio.checked = true;
                    document.getElementById('bypassSettings').style.display = 'none';
                } else {
                    disableRadio.checked = true;
                    document.getElementById('bypassSettings').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Failed to load diagnostic status:', error);
                const statusDiv = document.getElementById('diagnosticStatus');
                statusDiv.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.style.color = '#dc3545';
                errorDiv.textContent = 'Failed to load diagnostic status';
                statusDiv.appendChild(errorDiv);
            }
        }
        
        async function toggleEnforcement(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const enforcement = formData.get('enforcement');
            const enabled = enforcement === 'enable';
            
            // Add confirmation dialog for disabling enforcement
            if (!enabled) {
                const confirmed = confirm(
                    'WARNING: This will disable API key enforcement across the entire system. ' +
                    'Are you sure you want to proceed? This action should only be used for debugging.'
                );
                if (!confirmed) {
                    return;
                }
            }
            
            const requestBody = { enabled };
            
            if (!enabled) {
                const duration = parseInt(document.getElementById('bypassDuration').value);
                const allowedIPs = document.getElementById('allowedIPs').value.trim();
                
                if (!duration || duration < 1) {
                    const messageDiv = document.getElementById('toggleMessage');
                    messageDiv.textContent = '';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.textContent = 'Duration is required when disabling enforcement';
                    messageDiv.appendChild(errorDiv);
                    return;
                }
                
                requestBody.duration_minutes = duration;
                if (allowedIPs) {
                    requestBody.allowed_ips = allowedIPs;
                }
            }
            
            try {
                const response = await fetch('/admin/diagnostics/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                const messageDiv = document.getElementById('toggleMessage');
                messageDiv.textContent = '';
                
                if (response.ok) {
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success';
                    successDiv.textContent = data.message;
                    messageDiv.appendChild(successDiv);
                    loadDiagnosticStatus(); // Refresh status
                } else if (response.status === 401) {
                    localStorage.removeItem('adminToken');
                    location.reload();
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.textContent = data.detail;
                    messageDiv.appendChild(errorDiv);
                }
            } catch (error) {
                console.error('Failed to toggle enforcement:', error);
                const messageDiv = document.getElementById('toggleMessage');
                messageDiv.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = 'Failed to update enforcement settings';
                messageDiv.appendChild(errorDiv);
            }
        }
        
        async function runTest(event, testType) {
            event.preventDefault();
            
            const requestBody = { test_type: testType };
            
            if (testType === 'api_key') {
                const apiKey = document.getElementById('testApiKey').value.trim();
                if (!apiKey) {
                    const resultsDiv = document.getElementById('testResults');
                    resultsDiv.textContent = '';
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = '#dc3545';
                    errorDiv.textContent = 'Please enter an API key to test';
                    resultsDiv.appendChild(errorDiv);
                    return;
                }
                requestBody.api_key = apiKey;
            }
            
            try {
                const response = await fetch('/admin/diagnostics/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('adminToken');
                    location.reload();
                    return;
                }
                
                const data = await response.json();
                const resultsDiv = document.getElementById('testResults');
                
                if (response.ok) {
                    // Create safe DOM structure instead of innerHTML
                    const resultsDiv = document.getElementById('testResults');
                    resultsDiv.textContent = '';
                    
                    const containerDiv = document.createElement('div');
                    containerDiv.style.cssText = 'background: white; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-top: 10px;';
                    
                    const titleEl = document.createElement('h5');
                    titleEl.style.cssText = 'margin: 0 0 10px 0; color: #495057;';
                    titleEl.textContent = 'Test Results';
                    containerDiv.appendChild(titleEl);
                    
                    data.results.forEach(result => {
                        const color = result.result === 'PASS' ? '#28a745' : 
                                    result.result === 'FAIL' ? '#dc3545' : '#17a2b8';
                        
                        const resultDiv = document.createElement('div');
                        resultDiv.style.cssText = `margin: 8px 0; padding: 8px; background: #f8f9fa; border-radius: 3px; border-left: 3px solid ${color};`;
                        
                        const testLabel = document.createElement('strong');
                        testLabel.textContent = result.test + ': ';
                        
                        const resultSpan = document.createElement('span');
                        resultSpan.style.cssText = `color: ${color}; font-weight: 600;`;
                        resultSpan.textContent = result.result;
                        
                        const detailsEl = document.createElement('small');
                        detailsEl.style.cssText = 'color: #6c757d; display: block;';
                        detailsEl.textContent = result.details;
                        
                        resultDiv.appendChild(testLabel);
                        resultDiv.appendChild(resultSpan);
                        resultDiv.appendChild(document.createElement('br'));
                        resultDiv.appendChild(detailsEl);
                        containerDiv.appendChild(resultDiv);
                    });
                    
                    const timestampEl = document.createElement('small');
                    timestampEl.style.color = '#6c757d';
                    timestampEl.textContent = `Test completed at: ${new Date(data.timestamp).toLocaleString()}`;
                    containerDiv.appendChild(timestampEl);
                    
                    resultsDiv.appendChild(containerDiv);
                } else {
                    const resultsDiv = document.getElementById('testResults');
                    resultsDiv.textContent = '';
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'color: #dc3545; margin-top: 10px;';
                    errorDiv.textContent = `Test failed: ${data.detail}`;
                    resultsDiv.appendChild(errorDiv);
                }
            } catch (error) {
                console.error('Failed to run test:', error);
                const resultsDiv = document.getElementById('testResults');
                resultsDiv.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'color: #dc3545; margin-top: 10px;';
                errorDiv.textContent = 'Failed to run diagnostic test';
                resultsDiv.appendChild(errorDiv);
            }
        }
        
        async function loadDiagnosticLogs() {
            const outcomeFilter = document.getElementById('logOutcomeFilter').value;
            const ipFilter = document.getElementById('logIpFilter').value.trim();
            
            let url = '/admin/diagnostics/logs?page=1&page_size=20';
            if (outcomeFilter) url += `&outcome=${encodeURIComponent(outcomeFilter)}`;
            if (ipFilter) url += `&client_ip=${encodeURIComponent(ipFilter)}`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + sessionToken }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('adminToken');
                    location.reload();
                    return;
                }
                const data = await response.json();
                
                const logsDiv = document.getElementById('diagnosticLogs');
                
                if (data.logs && data.logs.length > 0) {
                    // Create safe DOM structure to prevent XSS from user-controlled log data
                    const logsDiv = document.getElementById('diagnosticLogs');
                    logsDiv.textContent = '';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.style.cssText = 'padding: 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;';
                    headerDiv.textContent = `Showing ${data.logs.length} of ${data.total} logs`;
                    logsDiv.appendChild(headerDiv);
                    
                    data.logs.forEach(log => {
                        const outcomeColor = log.outcome === 'allowed' ? '#28a745' : 
                                           log.outcome === 'denied' ? '#dc3545' : '#ffc107';
                        const timestamp = new Date(log.ts).toLocaleString();
                        
                        const logDiv = document.createElement('div');
                        logDiv.style.cssText = 'padding: 12px; border-bottom: 1px solid #e9ecef; font-size: 13px;';
                        
                        const headerRow = document.createElement('div');
                        headerRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;';
                        
                        const pathSpan = document.createElement('span');
                        pathSpan.style.cssText = 'font-weight: 600; color: #495057;';
                        pathSpan.textContent = log.path; // Safe: textContent prevents XSS
                        
                        const outcomeSpan = document.createElement('span');
                        outcomeSpan.style.cssText = `background: ${outcomeColor}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; text-transform: uppercase;`;
                        outcomeSpan.textContent = log.outcome; // Safe: textContent prevents XSS
                        
                        headerRow.appendChild(pathSpan);
                        headerRow.appendChild(outcomeSpan);
                        logDiv.appendChild(headerRow);
                        
                        const detailsDiv = document.createElement('div');
                        detailsDiv.style.cssText = 'color: #6c757d; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;';
                        
                        const ipSpan = document.createElement('span');
                        const ipLabel = document.createElement('strong');
                        ipLabel.textContent = 'IP: ';
                        ipSpan.appendChild(ipLabel);
                        ipSpan.appendChild(document.createTextNode(log.client_ip)); // Safe: prevents XSS from malicious IPs
                        detailsDiv.appendChild(ipSpan);
                        
                        const timeSpan = document.createElement('span');
                        const timeLabel = document.createElement('strong');
                        timeLabel.textContent = 'Time: ';
                        timeSpan.appendChild(timeLabel);
                        timeSpan.appendChild(document.createTextNode(timestamp));
                        detailsDiv.appendChild(timeSpan);
                        
                        if (log.key_hash_prefix) {
                            const keySpan = document.createElement('span');
                            const keyLabel = document.createElement('strong');
                            keyLabel.textContent = 'Key: ';
                            keySpan.appendChild(keyLabel);
                            keySpan.appendChild(document.createTextNode(log.key_hash_prefix + '...'));
                            detailsDiv.appendChild(keySpan);
                        }
                        
                        if (log.reason_code) {
                            const reasonSpan = document.createElement('span');
                            const reasonLabel = document.createElement('strong');
                            reasonLabel.textContent = 'Reason: ';
                            reasonSpan.appendChild(reasonLabel);
                            reasonSpan.appendChild(document.createTextNode(log.reason_code)); // Safe: prevents XSS from reason codes
                            detailsDiv.appendChild(reasonSpan);
                        }
                        
                        logDiv.appendChild(detailsDiv);
                        logsDiv.appendChild(logDiv);
                    });
                } else {
                    const logsDiv = document.getElementById('diagnosticLogs');
                    logsDiv.textContent = '';
                    const emptyDiv = document.createElement('div');
                    emptyDiv.style.cssText = 'text-align: center; padding: 20px; color: #6c757d;';
                    emptyDiv.textContent = 'No diagnostic logs found matching your filters';
                    logsDiv.appendChild(emptyDiv);
                }
            } catch (error) {
                console.error('Failed to load diagnostic logs:', error);
                const logsDiv = document.getElementById('diagnosticLogs');
                logsDiv.textContent = '';
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'text-align: center; padding: 20px; color: #dc3545;';
                errorDiv.textContent = 'Failed to load diagnostic logs';
                logsDiv.appendChild(errorDiv);
            }
        }
        
        function showKeyHash(keyHash, keyName) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);';
            
            // Modal header
            const header = document.createElement('h3');
            header.style.cssText = 'margin: 0 0 20px 0; color: #495057; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;';
            header.textContent = `üîë API Key Hash - ${keyName}`;
            
            // Explanation text
            const explanation = document.createElement('p');
            explanation.style.cssText = 'color: #6c757d; margin: 15px 0; line-height: 1.5;';
            explanation.innerHTML = '<strong>Note:</strong> For security reasons, the original API key cannot be displayed. This is the cryptographic hash that identifies your key in our system. If you\'ve lost the original API key, you\'ll need to create a new one.';
            
            // Hash container
            const hashContainer = document.createElement('div');
            hashContainer.style.cssText = 'background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 15px 0; font-family: monospace; word-break: break-all;';
            
            const hashLabel = document.createElement('div');
            hashLabel.style.cssText = 'font-size: 14px; color: #6c757d; margin-bottom: 8px; font-family: sans-serif; font-weight: 600;';
            hashLabel.textContent = 'Key Hash (SHA-256):';
            
            const hashValue = document.createElement('div');
            hashValue.style.cssText = 'font-size: 14px; color: #212529; user-select: all; cursor: pointer; background: white; padding: 10px; border-radius: 4px; border: 1px solid #ced4da;';
            hashValue.textContent = keyHash;
            hashValue.onclick = function() {
                navigator.clipboard.writeText(keyHash).then(() => {
                    const originalText = hashValue.textContent;
                    hashValue.textContent = '‚úì Hash copied to clipboard!';
                    hashValue.style.color = '#28a745';
                    setTimeout(() => {
                        hashValue.textContent = originalText;
                        hashValue.style.color = '#212529';
                    }, 2000);
                });
            };
            
            // Buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;';
            
            const copyBtn = document.createElement('button');
            copyBtn.textContent = 'Copy Hash';
            copyBtn.style.cssText = 'background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;';
            copyBtn.onclick = function() {
                navigator.clipboard.writeText(keyHash).then(() => {
                    copyBtn.textContent = '‚úì Copied!';
                    copyBtn.style.background = '#20c997';
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy Hash';
                        copyBtn.style.background = '#17a2b8';
                    }, 2000);
                });
            };
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Close';
            closeBtn.style.cssText = 'background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;';
            closeBtn.onclick = function() {
                modal.remove();
            };
            
            // Assembly
            hashContainer.appendChild(hashLabel);
            hashContainer.appendChild(hashValue);
            
            buttonContainer.appendChild(copyBtn);
            buttonContainer.appendChild(closeBtn);
            
            modalContent.appendChild(header);
            modalContent.appendChild(explanation);
            modalContent.appendChild(hashContainer);
            modalContent.appendChild(buttonContainer);
            
            modal.appendChild(modalContent);
            
            // Close on background click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            
            // Add to page
            document.body.appendChild(modal);
            
            // Focus on hash for easy copying
            hashValue.focus();
        }
        
        // Add event listeners for bypass settings toggle
        document.addEventListener('DOMContentLoaded', function() {
            // Add immediate radio button change handlers
            const enforcementRadios = document.querySelectorAll('input[name="enforcement"]');
            enforcementRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const bypassSettings = document.getElementById('bypassSettings');
                    if (this.value === 'disable') {
                        bypassSettings.style.display = 'block';
                        // Ensure duration field is focused for user convenience
                        setTimeout(() => {
                            document.getElementById('bypassDuration').focus();
                        }, 100);
                    } else {
                        bypassSettings.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>